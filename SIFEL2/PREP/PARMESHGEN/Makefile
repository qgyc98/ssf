####################################################################
#
#  Makefile for preprocessing part of SIFEL
#
####################################################################



################################################################### 
#  Include default part of Makefile - 
#  compiler definitions, flags, libraries ...
#
include ../../Makefile.in



################################################################### 
#  List of include directories
#
INCLUDES        =../../GEFEL/:../../GEFEL/PARSER/:../../GEFEL/OPTIM:../../GEFEL/RANDY:../../GEFEL/CMLFILE:../../MEFEL/PREP:../../TRFEL/PREP:../../TRFEL/SRC:



################################################################### 
#  List of local libraries
#
LOC_LIBS  =  -lmprep -lmef -lgef
LOC_TPLIBS = -ltprep -ltrf -lgef



####################################################################
#  List of source files
#
SRCS =  pargenbrick.cpp pargenbrickd.cpp pargenbrickdd.cpp pargenlay.cpp pargenqh.cpp pargenquad.cpp pargenquadd.cpp pargenquadt.cpp pargenquadq.cpp pargent3d.cpp 
SRCS += pargentria.cpp pargentriad.cpp seqpargenbrick.cpp seqpargenquad.cpp

# list of source files which depend on transprep
PTSRCS = pargenlst_transprep.cpp 



####################################################################
#  List of object files
#
OBJS         := $(SRCS:%.cpp=$(OUTPUTPATH)%.o)
PTOBJS       := $(PTSRCS:%.cpp=$(OUTPUTPATH)%.o)



####################################################################
#  List of executables
#
MOBJS        := $(SRCS:%.cpp=$(OUTPUTPATH)%)
MPTOBJS      := $(PTSRCS:%.cpp=$(OUTPUTPATH)%)



####################################################################
#  List of source dependency files
#
DEPS         := $(SRCS:%.cpp=$(OUTPUTPATH)%.d)



####################################################################
#  List of lib files
#

# libraries which preprocessors depends on
LIBDEPS    := $(SIFEL_ROOT)$(BIN_ROOT)GEFEL/$(OUTPUTDIR)libgef.a
LIBDEPS    += $(SIFEL_ROOT)$(BIN_ROOT)MEFEL/$(OUTPUTDIR)libmef.a
LIBDEPS    += $(SIFEL_ROOT)$(BIN_ROOT)TRFEL/$(OUTPUTDIR)libmprep.a

PTLIBDEPS    := $(SIFEL_ROOT)$(BIN_ROOT)GEFEL/$(OUTPUTDIR)libgef.a
PTLIBDEPS    += $(SIFEL_ROOT)$(BIN_ROOT)MEFEL/$(OUTPUTDIR)libtrf.a
PTLIBDEPS    += $(SIFEL_ROOT)$(BIN_ROOT)TRFEL/$(OUTPUTDIR)libtprep.a

# path to directories with needed libraries for the preprocessors target
DIR_LIBS   := -L$(SIFEL_ROOT)$(BIN_ROOT)GEFEL/$(OUTPUTDIR)
DIR_LIBS   += -L$(SIFEL_ROOT)$(BIN_ROOT)MEFEL/SRC/$(OUTPUTDIR)
DIR_LIBS   += -L$(SIFEL_ROOT)$(BIN_ROOT)MEFEL/PREP/$(OUTPUTDIR)

PTDIR_LIBS := -L$(SIFEL_ROOT)$(BIN_ROOT)GEFEL/$(OUTPUTDIR)
PTDIR_LIBS += -L$(SIFEL_ROOT)$(BIN_ROOT)TRFEL/SRC/$(OUTPUTDIR)
PTDIR_LIBS += -L$(SIFEL_ROOT)$(BIN_ROOT)TRFEL/PREP/$(OUTPUTDIR)



###########################################################################################
#  Following targets will be made regardless of whether there are files with the same names
#
.PHONY : mechprep transprep generators



####################################################################
#  Targets
#
all:  generators

generators: mechprep transprep $(MOBJS) $(MPTOBJS)
	@(echo "##### Preprocessors were successfully created")

$(MOBJS): $(LIBDEPS) $(OBJS) | $(OUTPUTPATH)
	$(CC) -o $@ $@.o $(EXECFLAGS) $(DIR_LIBS) $(LOC_LIBS) $(SYS_LIBS)

$(MPTOBJS): $(PTLIBDEPS) $(PTOBJS) | $(OUTPUTPATH)
	$(CC) -o $@ $@.o $(EXECFLAGS) $(PTDIR_LIBS) $(LOC_TPLIBS) $(SYS_LIBS)

$(OBJS):    | $(OUTPUTPATH)

$(PTOBJS):  | $(OUTPUTPATH)

$(OUTPUTPATH):
	@(mkdir -p $(OUTPUTPATH))

$(LIBDEPS): mechprep

$(PTLIBDEPS): transprep

clean:
	@($(RM) $(OBJS) $(PTOBJS) $(MOBJS) $(MPTOBJS) $(DEPS) *~ core)
	@(echo " Preprocessors were successfully cleaned")

cleanall: $(LIBDEPS)
	@($(RM) -r -f $(addprefix $(SIFEL_ROOT)$(BIN_ROOT)$(MODULE_PATH),$(REMOVEDIR)))
	@(echo " Preprocessors were successfully cleaned")

cleandepall: $(LIBDEPS)
	@($(RM) -r -f $(SIFEL_ROOT)$(BIN_ROOT)$(MODULE_PATH))
	@(echo " metr was successfully cleaned")



####################################################################
#  List of targets with dependent modules
#
gefel:
	+@(cd ../../GEFEL; make $(MAKECMDGOALS))

mechprep: |gefel;
	+@(cd ../../MEFEL/PREP; make $(MAKECMDGOALS))

transprep: |gefel;
	+@(cd ../../TRFEL/PREP; make $(MAKECMDGOALS))



####################################################################
#  Dependencies generated by compilers
#
-include $(DEPS)



####################################################################
#  Suffix rules
#
$(OUTPUTPATH)%.o : %.cpp
	@export CPATH=$(INCLUDES); \
	echo $(CC) $(CFLAGS) -c $(<D)/$(<F); \
	$(CC) $(CFLAGS) $(COMPATFLAGS) $(DEFS) -c $(<D)/$(<F) -o $(@D)/$(@F)
